---
layout: post
title: "Resolving 'Can't connect to window server - not enough permissions' forMaven test runs"
date: 2011-08-26
type: posts
---

<div class='post'>
Our CI server (we use Jenkins) recently began bombing on several new tests that referenced java.awt packaged classes. The most common error in the stacktrace was "NoClassDefFoundError: Could not initialize class java.awt.Color" and diving deeper we could see the root cause was  "Can't connect to window server - not enough permissions".<br />The interwebs all claimed setting <code class="java plain">-Djava.awt.headless=true</code> would resolve the issue but it did nothing for us. We set it as a Jenkins system parameter, in the launchctl job, in the bash_profile of the Jenkins user on the machine, and everywhere we could in the Jenkins job itself....to no avail.<br />Just before heading down the path of setting it programatically somewhere in our test stack - I noticed that our&nbsp;maven-surefire-plugin was configured to use a threadCount of 10. On a hunch that&nbsp;maven-surefire-plugin was not exporting my system properties to the new threads it spawned for the test run - I configured the plugin to set java.awt.headless with the following snip from our pom.xml<br /><div class="CodeRay"><div class="code"><pre>&lt;plugin&gt; &nbsp;</pre><pre>&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &nbsp;</pre><pre>&lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt; &nbsp;</pre><pre>&lt;version&gt;2.5&lt;/version&gt; &nbsp;</pre><pre>&lt;configuration&gt;       &nbsp;</pre><pre>&lt;excludes&gt;        &nbsp;</pre><pre>&lt;exclude&gt;**/TestInstanceBakerTest.java&lt;/exclude&gt;        &nbsp;</pre><pre>&lt;exclude&gt;**/ExpectedAnswerGeneratorTest.java&lt;/exclude&gt;        &nbsp;</pre><pre>&lt;exclude&gt;**/ClientNukeTest.java&lt;/exclude&gt;        &nbsp;</pre><pre>&lt;exclude&gt;**/TestInstanceBank.java&lt;/exclude&gt;       &nbsp;</pre><pre>&lt;/excludes&gt;   &nbsp;</pre><pre>&lt;parallel&gt;true&lt;/parallel&gt;   &nbsp;</pre><pre>&lt;threadCount&gt;10&lt;/threadCount&gt;     &nbsp;</pre><pre>&lt;systemPropertyVariables&gt;         &nbsp;</pre><pre>&lt;java.awt.headless&gt;true&lt;/java.awt.headless&gt;         &nbsp;</pre><pre>&lt;log4j.configuration&gt;${runtime.log4j.config}&lt;/log4j.configuration&gt;                                       &nbsp;</pre><pre>&lt;/systemPropertyVariables&gt;               &nbsp;</pre><pre>&lt;/configuration&gt;&lt;/plugin&gt;</pre><pre><br /></pre></div></div>Problem solved.</div>
