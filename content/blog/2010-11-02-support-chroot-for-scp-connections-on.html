---
layout: post
title: "Support chroot for SCP connections on CentOS 5.5"
date: 2010-11-02
type: posts
---

<div class='post'>
<p>Many thanks to <a href="http://www.linuxquestions.org/questions/red-hat-31/my-version-of-ssh-doesnt-support-match-and-forcecommand-819436/">anomie for posting this great writeup</a>. I've pasted it below to help spread the wealth.<p />-------<p />Here's a quick recipe for your chrooted sftp daemon:<p />1. Create the sftp init script - &lt;strong&gt;/etc/init.d/sftpfoo&lt;/strong&gt;<br /><code>#!/bin/bash## chkconfig: 35 60 25# description: OpenSSH chrooted sftp only daemon## Note that /usr/sbin/sftpfoo is simply a symlink to /usr/sbin/sshd#</code><p />pidfile='/var/run/sftpfoo.pid'<p />case "${1}" in<p />start&nbsp; ) exec -a /usr/sbin/sftpfoo /usr/sbin/sshd -f /etc/ssh/sftpfoo_config<br />;;<br />stop&nbsp;&nbsp; ) kill -9 $(cat ${pidfile})<br />;;<br />restart) stop<br />sleep 3<br />start<br />;;<br />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ) echo "Usage: ${0} (start|stop|restart)"<br />;;<p />esac<p />exit 0<p />2. Add it to chkconfig(8) consciousness and set up a symlink you'll need later.<p /><code># chkconfig --add sftpfoo# ln -s /usr/sbin/sshd /usr/sbin/sftpfoo</code><p />3. Create your sftp config file - &lt;strong&gt;/etc/ssh/sftpfoo_config&lt;/strong&gt;<p /><code>Port 8822Protocol 2AddressFamily inet</code><p />SyslogFacility AUTHPRIV<br />LogLevel INFO<p />PermitRootLogin no<p />RSAAuthentication no<br />PubkeyAuthentication no<br />RhostsRSAAuthentication no<br />HostbasedAuthentication no<br />PasswordAuthentication yes<br />PermitEmptyPasswords no<br />ChallengeResponseAuthentication no<br />KerberosAuthentication no<br />GSSAPIAuthentication no<p />UsePAM no<p />PidFile /var/run/sftpfoo.pid<p />ChrootDirectory /home/chrooted<br />Subsystem sftp internal-sftp<p />4. Create your first sftp-only user<p /><code># useradd -d /nowhere -M -s /sbin/nologin baruser</code><p />5. Create the chroot directory<p /><code># mkdir -p /home/chrooted &amp;amp;&amp;amp; chmod 755 /home/chrooted</code><p />6. Start the sftp service<p /><code># service sftpfoo start</code><br />-------<p />Now, log in remotely as baruser, specifying port 8822. (Remember to poke a hole in your firewall for this port.)</p></div>
