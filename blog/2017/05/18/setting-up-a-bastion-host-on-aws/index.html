<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Setting up a Bastion host on AWS - technocracy</title><meta name=Description content="My corner of the web where I sporadically capture musings"><meta property="og:title" content="Setting up a Bastion host on AWS"><meta property="og:description" content="When setting up my latest development environment at AWS, I wanted to deploy all EC2 services on a private VPC and simply route all traffic to them through a Bastion host (aka jump host)."><meta property="og:type" content="article"><meta property="og:url" content="https://www.ericsimmerman.com/blog/2017/05/18/setting-up-a-bastion-host-on-aws/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-05-18T17:01:41+00:00"><meta property="article:modified_time" content="2017-05-18T17:01:41+00:00"><meta property="og:site_name" content="technocracy"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setting up a Bastion host on AWS"><meta name=twitter:description content="When setting up my latest development environment at AWS, I wanted to deploy all EC2 services on a private VPC and simply route all traffic to them through a Bastion host (aka jump host)."><meta name=application-name content="technocracy"><meta name=apple-mobile-web-app-title content="technocracy"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://www.ericsimmerman.com/blog/2017/05/18/setting-up-a-bastion-host-on-aws/><link rel=prev href=https://www.ericsimmerman.com/blog/2017/05/16/knock-first-firewall-for-aws-security-groups/><link rel=next href=https://www.ericsimmerman.com/blog/2018/11/09/dry-in-ms-word-on-a-mac/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Setting up a Bastion host on AWS","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.ericsimmerman.com\/blog\/2017\/05\/18\/setting-up-a-bastion-host-on-aws\/"},"genre":"posts","keywords":"AWS, bastion, jumphost","wordcount":473,"url":"https:\/\/www.ericsimmerman.com\/blog\/2017\/05\/18\/setting-up-a-bastion-host-on-aws\/","datePublished":"2017-05-18T17:01:41+00:00","dateModified":"2017-05-18T17:01:41+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Eric Simmerman"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=technocracy>technocracy</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/>Blog </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=technocracy>technocracy</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/blog/ title>Blog</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Setting up a Bastion host on AWS</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Eric Simmerman</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2017-05-18>2017-05-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;473 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;3 minutes&nbsp;</div></div><div class=content id=content><p>When setting up my latest development environment at AWS, I wanted to deploy all EC2 services on a private VPC and simply route all traffic to them through a Bastion host (aka jump host). AWS maintains a an <a href=http://docs.aws.amazon.com/quickstart/latest/linux-bastion/welcome.html target=_blank rel="noopener noreffer">excellent CloudFormation quickstart guide & template here</a> and it&rsquo;s what I used to get started. After completing that guide I put a new entry for the Bastion host in my ssh config like so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Host bastion
</span></span><span class=line><span class=cl>  Hostname ec2-XX-XXX-XXX-XXX.compute-1.amazonaws.com
</span></span><span class=line><span class=cl>  User ec2-user
</span></span><span class=line><span class=cl>  IdentityFile ~/path/to/your/ssh-key.pem
</span></span><span class=line><span class=cl>  AddKeysToAgent yes
</span></span><span class=line><span class=cl>  UseKeychain yes
</span></span></code></pre></div><p>Those last two lines are optional - but I like to <a href=http://www.openssh.com/txt/release-7.2 target=_blank rel="noopener noreffer">leverage the Keychain on my MacBookPro</a> for storing keys and their respective passphrases. Accepting the host key into your known_hosts file can avoid some pain going forward, so I recommend connecting directly to the bastion before continuing.</p><p>To test my setup, I launched a EC2 instance in my private VPC and configured it in my ssh config like so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Host 10.100.*.*
</span></span><span class=line><span class=cl>  ProxyCommand ssh ec2-user@bastion -W %h:%p
</span></span><span class=line><span class=cl>  User ec2-user
</span></span><span class=line><span class=cl>  IdentityFile ~/path/to/your/ssh-key.pem
</span></span><span class=line><span class=cl>  AddKeysToAgent yes
</span></span><span class=line><span class=cl>  UseKeychain yes
</span></span></code></pre></div><p>The magic happens on the second line with the ProxyCommand instructing SSH to jump through Bastion to route to any of the private IP addresses used in my development environment VPC. Unfortunately, my first attempt to connect failed. I poked around in the Bastion&rsquo;s SSHD config and realized that the CloudFront template was so hardened that it wasn&rsquo;t going to support the transparent sessions I wanted. I needed to modify /etc/ssh/sshd_config and add the following just below the PAM section:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PermitOpen any
</span></span><span class=line><span class=cl>AllowTCPForwarding yes
</span></span></code></pre></div><p>After making the change be certain to restart the sshd service on Bastion.</p><p>Part of the beauty of the CloudFormation design is that it uses an AutoScaling group to automatically tear down unresponsive Bastions and spin up replacements - even adapting to availability zone issues. When that happens the replacement Bastion will be configured with template defaults, so to ensure my sshd_config change would survive a failover, I copied the LaunchConfig and edited the user data to include the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>perl -pi -0 -w -e &#39;s/UsePAM yes/UsePam yes\n\n# Added by ets to support transparent pass through\nPermitOpen any\nAllowTCPForwarding yes/&#39; sshd_config
</span></span></code></pre></div><p>Then I replaced the currently configured LaunchConfig on my AutoScaling group with my copy.</p><p>Now simply asking SSH to connect to my new services in the private VPC worked transparently!<br>To make session more efficient using this type of proxy, I added the following to my Bastion host entry in ssh config:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ControlPath ~/.ssh/cm-%r@%h:%p
</span></span><span class=line><span class=cl>ControlMaster auto
</span></span><span class=line><span class=cl>ControlPersist 10m
</span></span></code></pre></div><p>If you&rsquo;re an <a href=https://www.ansible.com/ target=_blank rel="noopener noreffer">ansible</a> fan like me, you can take advantage of that same technique with a change to ansible.cfg:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ssh_args = -o ControlMaster=auto -o ControlPersist=30m
</span></span><span class=line><span class=cl>control_path = ~/.ssh/ansible-%%r@%%h:%%p
</span></span></code></pre></div><p>If you&rsquo;re curious how to further protect your Bastion host with a whitelist for port 22 while also supporting users who are behind dynamic IPs then you&rsquo;ll want to <a href=/2017/05/16/2017-05-16-aws-lambda-firewall/ rel>check out my aws-lambda-firewall project</a>.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2017-05-18</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://www.ericsimmerman.com/blog/2017/05/18/setting-up-a-bastion-host-on-aws/ data-title="Setting up a Bastion host on AWS" data-via=ericsimmerman data-hashtags=AWS,bastion,jumphost><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://www.ericsimmerman.com/blog/2017/05/18/setting-up-a-bastion-host-on-aws/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://www.ericsimmerman.com/blog/2017/05/18/setting-up-a-bastion-host-on-aws/ data-title="Setting up a Bastion host on AWS"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://www.ericsimmerman.com/blog/2017/05/18/setting-up-a-bastion-host-on-aws/ data-title="Setting up a Bastion host on AWS"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://www.ericsimmerman.com/blog/2017/05/18/setting-up-a-bastion-host-on-aws/ data-title="Setting up a Bastion host on AWS"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/aws/>AWS</a>,&nbsp;<a href=/tags/bastion/>bastion</a>,&nbsp;<a href=/tags/jumphost/>jumphost</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/blog/2017/05/16/knock-first-firewall-for-aws-security-groups/ class=prev rel=prev title="Knock first firewall for AWS Security Groups"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Knock first firewall for AWS Security Groups</a>
<a href=/blog/2018/11/09/dry-in-ms-word-on-a-mac/ class=next rel=next title="DRY in MS Word on a Mac">DRY in MS Word on a Mac<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.102.1">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2006 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Eric Simmerman</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>